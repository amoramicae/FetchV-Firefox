importScripts("./js/options.js");let e=!1,t=1,r=!1;const n={};try{chrome.action.setBadgeTextColor({color:"#FFFFFF"}),chrome.action.setBadgeBackgroundColor({color:"#FF0000"})}catch(e){}const o=async e=>{if("getContexts"in chrome.runtime){const t=await chrome.runtime.getContexts({contextTypes:["OFFSCREEN_DOCUMENT"],documentUrls:[chrome.runtime.getURL(e)]});return Boolean(t.length)}{const t=await clients.matchAll();return await t.some((t=>t.url.endsWith(`/${e}`)))}},s=async()=>{if(!r)if("offscreen"in chrome){const e="offscreen.html";if(r=await o(e),r)return;try{await chrome.offscreen.createDocument({url:e,reasons:[chrome.offscreen.Reason.BLOBS],justification:"Convert blob data to blob URL"}),r=!0}catch(e){r=!1}}else r=!1},i=async()=>{const e=await chrome.storage.local.get(),t=await chrome.tabs.query({});for(const r of t){const t=`storage${r.id}`,o=e[t];"object"==typeof o&&Object.keys(o).length&&(n[t]=o,delete e[t])}e.tasks&&delete e.tasks,e.queue&&delete e.queue;const r=Object.keys(e);r.length&&chrome.storage.local.remove(r)},a=()=>{const e=e=>{e?.size?.min&&(e.size.min=1024*e.size.min,e.size.min<0&&(e.size.min=0)),e?.size?.max&&(e.size.max=1024*e.size.max,e.size.max<0&&(e.size.max=0))};return new Promise((t=>{try{chrome.storage.sync.get(["options"]).then((r=>{if(void 0!==r.options){const e=r.options;for(let t in OPTION)void 0!==e[t]&&"lang"!==t&&(OPTION[t]=e[t])}e(OPTION),t()}))}catch(r){e(OPTION),t()}}))},c=(e,t)=>{let r=Object.keys(e).length;r=r>0?r.toString():"",chrome.action.setBadgeText({text:r,tabId:t})},m=e=>{chrome.declarativeNetRequest.getSessionRules((function(t){const r=[];for(const n of t)void 0!==n.condition.tabIds&&n.condition.tabIds.includes(e)&&r.push(n.id);r.length>0&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:r})}))},l=e=>new Promise((t=>{e?t(e):chrome.declarativeNetRequest.getSessionRules((function(e){let r=2;for(const t of e)r=Math.max(r,t.id);r++,t(r)}))}));chrome.declarativeNetRequest.getSessionRules((async function(e){if(0===e.length)return;const t=await chrome.tabs.query({}),r=[];for(const e of t)r.includes(e.id)||r.push(e.id);const n=[];for(const t of e){if(void 0===t.condition.tabIds)continue;t.condition.tabIds.some((e=>r.includes(e)))||n.includes(t.id)||n.push(t.id)}n.length>0&&chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:n})})),chrome.runtime.onConnect.addListener((function(r){"POPUP"===r.name&&(e=!0,r.onDisconnect.addListener((function(){e=!1,chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[t]})})))})),chrome.runtime.onMessage.addListener((function(e,t,o){const{cmd:i,parameter:c}=e;if("REC_ON_DATA"===i){const{recorderTab:e,data:t}=c;return chrome.tabs.sendMessage(e,{cmd:i,parameter:{data:t}}),o(),!0}if("BG_FETCH"===i){let{url:e,headers:t,method:n}=c;return s().then((()=>{r?chrome.runtime.sendMessage({cmd:"OFFSCREEN_FETCH_DATA",parameter:{url:e,headers:t,method:n}},(e=>{e||(e={ok:!1,statusText:"Background Fetch Error"}),o(e)})):o({ok:!1,statusText:"Offscreen Error"})})),!0}if("GET_TAB_ID"===i)return chrome.tabs.query({}).then((e=>{const r=t.tab.id,n=e.length;o({currentTabId:r,tabsCount:n})})),!0;if("SET_RULES"===i){const{ruleObject:e,ruleId:t}=c;return l(t).then((t=>{try{e.id=t,chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[t],addRules:[e]},(function(){chrome.runtime.lastError&&console.log(chrome.runtime.lastError),o(t)}))}catch(e){o(0)}})),!0}if("REMOVE_RULES"===i){const{ruleId:e}=c;return chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:[e]}),o(),!0}if("OPEN_INITIATOR"===i){const{initiator:e}=c;return chrome.tabs.create({url:e,index:t.tab.index+1}),o(""),!0}if("GET_ICON"===i)return o(t.tab.favIconUrl),!0;if("RESET_OPTIONS"===i){const{storageKey:e}=c;return a().then((()=>{if(!e)return void o();const t=n[e],r=[];for(const e in t){const n=t[e],o=new URL(n.url).hostname;o&&OPTION.domain.includes(o)&&r.push(e)}if(r.length>0){for(const e of r)delete t[e];0===Object.keys(t).length?(delete n[e],chrome.storage.local.remove([e],(()=>{o()}))):chrome.storage.local.set({[e]:t},(()=>{o()}))}else o()})),!0}if("TAB_ACTIVE"===i)return chrome.tabs.update(t.tab.id,{active:!0},(()=>{o()})),!0;if("OPEN_DOWNLOADS"===i)return chrome.tabs.create({url:"chrome://downloads/",index:t.tab.index+1}),o(),!0;if("REC_START"===i){const{targetTab:e}=c;return chrome.tabs.update(e,{active:!0}),chrome.tabs.sendMessage(e,{cmd:i,parameter:{tab:t.tab.id}}),o(),!0}if("REC_STOP"===i){const{tabId:e}=c;return chrome.tabs.get(e,(e=>{chrome.runtime.lastError&&console.warn(chrome.runtime.lastError),e&&chrome.tabs.sendMessage(e.id,{cmd:i,parameter:{}},(()=>{chrome.runtime.lastError&&console.warn(chrome.runtime.lastError)}))})),o(),!0}if("REC_SPEED_UP"===i){const{targetTab:e,speed:t}=c;return chrome.tabs.get(e,(r=>{chrome.runtime.lastError&&console.warn(chrome.runtime.lastError),r&&chrome.tabs.sendMessage(e,{cmd:i,parameter:{speed:t}},(()=>{chrome.runtime.lastError&&console.warn(chrome.runtime.lastError)}))})),o(),!0}o()})),chrome.tabs.onRemoved.addListener((function(e){m(e);const t=`storage${e}`;chrome.storage.local.remove([t]),n[t]&&delete n[t]})),chrome.tabs.onUpdated.addListener((function(e,t,r){if("loading"===t.status&&t.url){const t=`storage${e}`;n[t]&&delete n[t],chrome.storage.local.remove([t],(()=>{c(n[t]||{},e)}))}})),async function(){await a(),await i();const t=(e,t)=>{e=e.toLowerCase();for(let r=0;r<t.length;r++)if(t[r].name.toLowerCase()===e)return t[r].value.toLowerCase();return null},r=(e,t)=>{let r={m3u8:"video/mp4",m3u:"video/mp4",mp4:"video/mp4","3gp":"video/3gpp",flv:"video/x-flv",mov:"video/quicktime",avi:"video/x-msvideo",wmv:"video/x-ms-wmv",webm:"video/webm",ogg:"video/ogg",ogv:"video/ogg",f4v:"video/x-f4v",acc:"application/vnd.americandynamics.acc",mkv:"video/x-matroska",rmvb:"application/vnd.rn-realmedia-vbr",m4s:"video/iso.segment",mp3:"audio/mpeg",wav:"audio/wav"};return r[e]?r[e]:t},o={},s=["youtube.com","globo.com"],m=["m3u8","m3u","mp4","3gp","flv","mov","avi","wmv","webm","f4v","acc","mkv","mp3","wav","ogg"],l=["range","content-length","content-type","accept-encoding","accept","accept-language"];chrome.webRequest.onBeforeSendHeaders.addListener((function(e){if(!e.initiator)return;if(0!==e.initiator.indexOf("http"))return;const t=e.requestHeaders;o[e.requestId]=t||{}}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["requestHeaders","extraHeaders"]),chrome.webRequest.onResponseStarted.addListener((async function(i){let{requestId:a,initiator:u,url:d,tabId:f,responseHeaders:p,statusCode:h}=i,g={};if(o[a]&&(g=o[a],delete o[a]),0!==d.indexOf("http"))return;if(!u)return;if(0!==u.indexOf("http"))return;const v=new URL(u).hostname;for(const e of s)if(v.endsWith(e))return;if(0===u.indexOf(OPTION.site))return;if(-1===f){if(!await new Promise((e=>{chrome.tabs.query({active:!0,lastFocusedWindow:!0}).then((([t])=>{t&&t.url.includes(u)?(f=t.id,e(!0)):e(!1)}))})))return}if(p.length<1)return;if(h<200||h>300)return;const b=new URL(d).hostname;if(b){if((e=>{const t=["doppiocdn","adtng","afcdn","sacdnssedge"],r=e.split(".");r.pop();const n=r.length;if(n>0){const e=r[n-1];if(t.indexOf(e)>-1)return!0}return!1})(b))return;if(OPTION.domain.includes(b))return}let O=0,w=(e=>{let r=t("Content-Range",e);return r?(r=r.split(" "),2!==r.length?null:(r=r[1].split("/"),2!==r.length?null:(r[1]=parseInt(r[1]),r[1]?{chunk:r[0],total:r[1]}:null))):null})(p);O=w?w.total:(e=>{let r=t("Content-Length",e);return r?(r=parseInt(r),r<1?0:r):0})(p);let x=t("content-type",p);if(!x){let{pathname:e}=new URL(d);if(e=e.toLowerCase(),"media"===i.type&&(e.endsWith(".mp4")&&(x="video/mp4"),e.endsWith(".webm")&&(x="video/webm")),"xmlhttprequest"===i.type&&e.endsWith(".m3u8")&&(x="application/vnd.apple.mpegurl"),!x)return}let R=(e=>{const{responseHeaders:r,url:n,type:o}=e;let s=null,i=t("content-disposition",r);if(i){i=i.split(";");for(let e=0;e<i.length;e++)if(i[e].indexOf("filename=")>-1){if(i[e]=i[e].replace(/filename=/i,"").replace(/\"/g,"").replace(/\'/g,"").replace(/(^\s*)|(\s*$)/g,""),s=i[e],s)return s;break}}return i=n.replace(/http:\/\//i,"").replace(/https:\/\//i,""),i=i.split("?"),i=i[0].split("/"),i.length<2?null:(i=i[i.length-1],i||"media"===o&&(i="undefined.mp4"),i||s)})(i);R||(R="no-filename");let T=((e,t)=>{if(e.includes("master.txt")&&0===t.indexOf("text/plain"))return"m3u8";let r=(e=>{let t=e.split(".");return t.length<2?null:t[t.length-1].toLowerCase()})(e);const n=["m3u8","m3u","mp4","webm","avi","ogg","flv","mkv","3gp","mp3"];let o={general:{"application/vnd.apple.mpegurl":["m3u8","m3u"],"application/x-mpegurl":["m3u8","m3u"],"application/vnd.americandynamics.acc":["acc"],"application/vnd.rn-realmedia-vbr":["rmvb"],"video/mp4":["mp4","m4s"],"video/3gpp":["3gp"],"video/3gpp2":["3gp2"],"video/x-flv":["flv"],"video/quicktime":["mov"],"video/x-msvideo":["avi"],"video/x-ms-wmv":["wmv"],"video/webm":["webm"],"video/ogg":["ogg","ogv"],"video/x-f4v":["f4v"],"video/x-matroska":["mkv"],"video/iso.segment":["m4s"],"audio/mpeg":["mp3"],"audio/wav":["wav"],"audio/ogg":["ogg"]},stream:{"application/octet-stream":n,"binary/octet-stream":n}};if(o.general[t]){if(!r)return o.general[t][0];let e=o.general[t].indexOf(r);return e<0?o.general[t][0]:o.general[t][e]}if(o.stream[t]){if(!r)return null;let e=o.stream[t].indexOf(r);return e<0?null:o.stream[t][e]}return n.includes(r)?r:null})(R,x);if(!T){if("xmlhttprequest"!==i.type||!w)return;if(!await((e,t)=>new Promise((r=>{const n=setTimeout((()=>{r(!1)}),1e3);chrome.tabs.sendMessage(t,{cmd:"CHECK_VIDEO",parameter:{url:e}},(e=>{clearTimeout(n),r(e)}))})))(d,f))return;T="mp4"}if(m.indexOf(T)<0)return;let E=T;if("m3u8"!==T&&"m3u"!==T){if(!O)return;if(OPTION.size.min&&O<OPTION.size.min)return;if(OPTION.size.max&&O>OPTION.size.max)return}else E="hls";const I=`storage${f}`;let y=n[I];if(y||(y={},n[I]=y),Object.keys(y).length>30)return;if(((e,t)=>{for(let r in t)if(t[r].url===e)return!0;return!1})(d,y))return void c(y,f);const P={};for(const e in g){const t=g[e];l.includes(t.name.toLowerCase())||(P[t.name]=t.value)}const N="POST"===i.method?"POST":"GET";y[a]={storageKey:I,requestId:a,url:d,method:N,format:T,contentType:r(T,x),name:R,size:O,headers:P,type:E},chrome.storage.local.set({[I]:y}),e&&chrome.runtime.sendMessage({cmd:"POPUP_APPEND_ITEMS",parameter:{tab:f,item:{[a]:y[a]}}}),c(y,f)}),{urls:["<all_urls>"],types:["media","xmlhttprequest","object","other"]},["responseHeaders"])}();